# Phase 0-A: コード品質評価レポート

**評価対象**: `legacy/mini_project_schedule/`
**評価日**: 2026-02-08
**評価者**: AI (o1 Model)

---

## 1. 概要 (Overview)

| ファイル | 行数 | 概要 |
|:---|---:|:---|
| `script.js` | 1,382 | 全ロジック（状態管理、日付計算、DOM操作、Gantt描画、D&D） |
| `index.html` | 177 | UIテンプレート（インラインスタイル多用） |
| `style.css` | 224 | 基本スタイル（グラスモーフィズム、レイアウト） |
| `gantt.css` | ~100? | ガントチャート専用スタイル |

**総評**: 機能は充実しているが、**全てが単一ファイルに集約されており、保守性・拡張性に課題**がある。

---

## 2. 構造・アーキテクチャ (Architecture)

### 問題点
| # | 問題 | 深刻度 | 説明 |
|:--|:---|:---:|:---|
| A1 | **モノリシック構造** | 🔴高 | 1,382行が1ファイルに存在。責務が混在。 |
| A2 | **グローバル変数** | 🟠中 | `appState`, `phaseListEl` 等がグローバルスコープ。 |
| A3 | **クラス/モジュール未使用** | 🔴高 | ES6 Class や ES Modules が未導入。 |
| A4 | **関心の分離なし** | 🔴高 | State / Logic / DOM / Render が混在。 |

### 推奨対応
- **責務ごとにファイル分割**:
  - `state.js` (状態管理 + LocalStorage)
  - `dateUtils.js` (日付計算ヘルパー)
  - `scheduler.js` (スケジュール計算ロジック)
  - `ui.js` (DOM操作 + レンダリング)
  - `gantt.js` (ガントチャート描画)
  - `main.js` (初期化 + イベント登録)

---

## 3. 可読性・保守性 (Readability & Maintainability)

### 問題点
| # | 問題 | 深刻度 | 説明 |
|:--|:---|:---:|:---|
| R1 | **関数の長さ** | 🟠中 | `renderPhases()` (100行), `applyGanttChange()` (130行) など巨大関数。 |
| R2 | **マジックナンバー** | 🟡低 | `PX_PER_DAY = 30`, 色コード等がハードコード。 |
| R3 | **コメント不足** | 🟠中 | 複雑なロジック（`calculateSchedule`）にコメントが少ない。 |
| R4 | **命名の一貫性** | 🟡低 | `getActiveData()` vs `getActiveTimeline()` の命名規則が曖昧。 |
| R5 | **インラインHTML** | 🟠中 | `row.innerHTML = \`...\`` で巨大なHTMLテンプレートが埋め込まれている。 |

### 推奨対応
- 巨大関数を **小さなヘルパー関数** に分割。
- 定数は **config.js** に集約。(`const CONFIG = { PX_PER_DAY: 30, ... }`)
- テンプレートは **テンプレートリテラル関数** または **コンポーネント化**。

---

## 4. パフォーマンス (Performance)

### 問題点
| # | 問題 | 深刻度 | 説明 |
|:--|:---|:---:|:---|
| P1 | **DOM再構築** | 🟠中 | `renderPhases()` で毎回 `innerHTML = ''` + 全要素再作成。 |
| P2 | **イベントリスナー重複** | 🟠中 | `attachPhaseListeners()` が呼ばれるたびにリスナー追加。 |
| P3 | **replaceWithClone()** | 🟡低 | ノード置換によるリスナー除去は非効率。イベント委譲推奨。 |

### 推奨対応
- **イベント委譲 (Event Delegation)** を採用し、親要素で一括ハンドリング。
- 差分更新（必要な部分のみ更新）を検討。

---

## 5. セキュリティ (Security)

### 問題点
| # | 問題 | 深刻度 | 説明 |
|:--|:---|:---:|:---|
| S1 | **XSS リスク** | 🟠中 | `row.innerHTML` にユーザー入力 (`phase.name`) を直接埋め込み。エスケープ処理なし。 |
| S2 | **LocalStorage直接利用** | 🟡低 | 問題は少ないが、将来API化する場合は要注意。 |

### 推奨対応
- HTMLエスケープ関数を作成し、全てのユーザー入力をサニタイズ。

---

## 6. テスト容易性 (Testability)

### 問題点
| # | 問題 | 深刻度 | 説明 |
|:--|:---|:---:|:---|
| T1 | **テストコードなし** | 🔴高 | 自動テストが存在しない。 |
| T2 | **DOM依存** | 🔴高 | ほぼ全関数がDOM要素に依存しており、単体テスト困難。 |
| T3 | **純粋関数の少なさ** | 🟠中 | `calculateSchedule` は比較的テスト可能だが、他は困難。 |

### 推奨対応
- ロジック（日付計算、スケジュール計算）を **純粋関数** として切り出し、Jestでテスト可能に。
- DOM操作はUI層に閉じ込め、**モック不要** な設計に。

---

## 7. 総合評価サマリー

| カテゴリ | スコア (5段階) | 備考 |
|:---|:---:|:---|
| アーキテクチャ | ⭐⭐☆☆☆ (2/5) | モノリシック、責務分離なし |
| 可読性 | ⭐⭐⭐☆☆ (3/5) | 巨大関数あるが、比較的読める |
| パフォーマンス | ⭐⭐⭐☆☆ (3/5) | 大きな問題なし、改善余地あり |
| セキュリティ | ⭐⭐⭐☆☆ (3/5) | XSSリスクあり |
| テスト容易性 | ⭐☆☆☆☆ (1/5) | テストなし、DOM依存高 |

---

## 8. リファクタリング優先度

1. **【最優先】ファイル分割・モジュール化**
   - すべての改善の土台となる。
2. **【高】XSSエスケープ導入**
   - セキュリティリスク軽減。
3. **【中】イベント委譲への移行**
   - パフォーマンス改善 + コードシンプル化。
4. **【中】テスト導入 (Jest)**
   - まずは `dateUtils.js`, `scheduler.js` から。
5. **【低】定数の集約、マジックナンバー排除**

---

> **次のステップ**: Phase 0-B (UI/UX評価) へ移行するため、**GPT-4o モデルへの切り替えを推奨**します。

---

## ドキュメント番号の意味

- ファイル名先頭の番号は推奨読込順を表します。
- 数字が小さいほど先に読む運用です。
- `90`番台は評価・方針などの参照資料です。
