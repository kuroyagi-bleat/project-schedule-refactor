<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Back-Scheduler</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="gantt.css">
    <script src="lib/html2canvas.min.js"></script>
</head>

<body>

    <div class="container">

        <!-- HEADER -->
        <header class="app-header">
            <div class="header-left">
                <h1>Project Back-Scheduler</h1>
                <div class="timeline-selector">
                    <select id="timeline-select"></select>
                    <button type="button" id="add-timeline-btn" class="icon-btn" title="追加">+</button>
                    <button type="button" id="rename-timeline-btn" class="icon-btn" title="リネーム">✎</button>
                    <button type="button" id="delete-timeline-btn" class="icon-btn" title="削除">×</button>
                </div>
            </div>
            <div class="header-actions">

                <button id="undo-btn" class="icon-btn" title="Undo (Ctrl+Z)">↩</button>
                <button id="redo-btn" class="icon-btn" title="Redo (Ctrl+Shift+Z)">↪</button>

                <button id="settings-toggle-btn" class="icon-btn" title="設定を開く/閉じる" aria-expanded="false">⚙</button>
                <input type="file" id="file-input" accept=".json" style="display:none">
            </div>
        </header>

        <!-- SETTINGS PANEL (Hidden by default) -->
        <div id="global-settings-panel" class="settings-panel" style="display:none;">
            <div class="settings-container">
                <!-- Environment Settings -->
                <div class="settings-section">
                    <div class="settings-header-row">
                        <h3>環境設定</h3>
                        <div class="settings-actions">
                            <button id="export-settings-btn" class="btn-secondary btn-small">設定を保存</button>
                            <button id="import-settings-btn" class="btn-secondary btn-small">設定を読込</button>
                            <input type="file" id="settings-file-input" accept=".json" style="display:none">
                        </div>
                    </div>

                    <div class="settings-grid-2col">
                        <div class="settings-col">
                            <label>祝日・休日 (YYYY-MM-DD)</label>
                            <span class="form-hint">※土日は自動で除外</span>
                            <textarea id="holidays-input" placeholder="2024-12-31&#10;2025-01-01"></textarea>
                        </div>

                        <div class="settings-col">
                            <label>工程プリセット</label>
                            <div class="preset-controls">
                                <div class="preset-add-form" style="display:flex; gap:0.5rem; width:100%;">
                                    <input type="text" id="new-preset-name" placeholder="プリセット名" style="flex:1;">
                                    <button id="save-preset-btn" class="btn-small">現在の状態を保存</button>
                                </div>
                            </div>
                            <div id="preset-list" class="preset-list">
                                <!-- Presets rendered here -->
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="settings-divider">

                <!-- Project Settings -->
                <div class="settings-section">
                    <div class="settings-header-row">
                        <h3>プロジェクト設定</h3>
                        <div class="settings-actions">
                            <button id="save-btn" class="btn-secondary btn-small">プロジェクト保存</button>
                            <button id="load-btn" class="btn-secondary btn-small">プロジェクト読込</button>
                        </div>
                    </div>
                    <p class="form-hint" style="margin-top:-10px; margin-bottom:10px;">※スケジュールはこちらに含まれます</p>

                    <div class="settings-col">
                        <label>タグ管理</label>
                        <div id="tag-manager-list" class="tag-manager-list"></div>
                        <div class="tag-add-form">
                            <input type="text" id="new-tag-name" placeholder="新しいタグ名" style="width:150px;">
                            <input type="color" id="new-tag-color" value="#38bdf8" class="color-picker">
                            <button id="add-tag-btn" class="btn-small">追加</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ANCHOR DATE BAR - REMOVED, moved to Phase Steps header -->
        <!-- 下位互換用: hidden -->
        <div style="display:none;">
            <select id="anchor-phase-select"></select>
            <input type="radio" name="top-anchor-type" value="start">
            <input type="radio" name="top-anchor-type" value="end" checked>
        </div>

        <!-- WORK AREA -->
        <div class="grid-layout">

            <!-- LEFT: SCHEDULE RESULT -->
            <div class="card">
                <div class="card-header">
                    <h3>スケジュール</h3>
                    <div class="card-actions">
                        <button id="copy-text-btn" class="btn-small">コピー</button>
                        <button id="sort-toggle-btn" class="btn-small"><span>昇順 ↓</span></button>
                    </div>
                </div>
                <div id="result-container"></div>
            </div>

            <!-- RIGHT: PHASES INPUT -->
            <div class="card">
                <div class="card-header phase-steps-header">
                    <div class="phase-steps-title">
                        <h3>工程一覧</h3>
                        <span id="current-sprint-name" class="sprint-name-badge"></span>
                    </div>

                </div>
                <div id="phase-list"></div>
                <button id="add-phase-btn" class="add-btn">+ 工程を追加</button>
            </div>

        </div>

        <!-- GANTT CHART -->
        <div class="card gantt-card">
            <div class="card-header">
                <h3>ガントチャート</h3>
                <div style="display:flex; gap:10px; margin-left: auto;">
                    <select id="tag-filter-select" class="tag-filter-select">
                        <option value="">全てのタグ</option>
                    </select>
                    <button id="export-image-btn" class="btn-small">画像保存</button>
                </div>
            </div>
            <div id="gantt-container"></div>
        </div>

    </div>

    <!-- カスタムモーダルダイアログ -->
    <div id="custom-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">タイトル</h3>
            </div>
            <div class="modal-body">
                <input type="text" id="modal-input" class="modal-input" placeholder="">
            </div>
            <div class="modal-footer">
                <button type="button" id="modal-cancel-btn" class="btn-secondary">キャンセル</button>
                <button type="button" id="modal-ok-btn" class="btn-primary">OK</button>
            </div>
        </div>
    </div>

    <!-- 確認ダイアログ -->
    <div id="confirm-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="confirm-title">確認</h3>
            </div>
            <div class="modal-body">
                <p id="confirm-message">メッセージ</p>
            </div>
            <div class="modal-footer">
                <button type="button" id="confirm-cancel-btn" class="btn-secondary">キャンセル</button>
                <button type="button" id="confirm-ok-btn" class="btn-primary">OK</button>
            </div>
        </div>
    </div>

    <!-- タグ選択モーダル -->
    <div id="tag-selection-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>タグ選択</h3>
            </div>
            <div class="modal-body">
                <p>このフェーズに適用するタグを選択してください（最大3つ）</p>
                <div id="tag-selection-container" class="tag-selection-grid">
                    <!-- Options rendered here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="tag-modal-cancel-btn" class="btn-secondary">キャンセル</button>
                <button type="button" id="tag-modal-ok-btn" class="btn-primary">OK</button>
            </div>
        </div>
    </div>

    <!-- ES Modules -->
    <script type="module" src="main.js"></script>
</body>

</html>